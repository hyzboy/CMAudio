# AudioPlayer 架构图和流程图

## 1. 类关系图

```
┌─────────────────────────────────────────────────────────────┐
│                         Thread                               │
│                      (基类-线程)                              │
└───────────────────────┬─────────────────────────────────────┘
                        │ 继承
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                      AudioPlayer                             │
├─────────────────────────────────────────────────────────────┤
│ - ThreadMutex lock                                          │
│ - AudioSource audiosource                                   │
│ - AudioPlugInInterface *decode                              │
│ - ALuint source, buffer[3]                                  │
│ - PlayState ps                                              │
│ - bool loop                                                 │
├─────────────────────────────────────────────────────────────┤
│ + Play(bool loop)                                           │
│ + Stop(), Pause(), Resume()                                 │
│ + Load(filename/stream)                                     │
│ + SetGain(), SetPitch()                                     │
│ + SetPosition(), SetVelocity()                              │
│ + AutoGain(), SetFadeTime()                                 │
│ # Execute() [Thread override]                               │
│ # ReadData(), UpdateBuffer()                                │
└────────┬──────────────────┬─────────────────────────────────┘
         │ 包含              │ 使用
         ▼                  ▼
┌─────────────────┐  ┌──────────────────────────────┐
│  AudioSource    │  │  AudioPlugInInterface        │
├─────────────────┤  ├──────────────────────────────┤
│ - uint index    │  │ + Open()                     │
│ - float gain    │  │ + Close()                    │
│ - float pitch   │  │ + Read()                     │
│ - Vector3f pos  │  │ + Restart()                  │
│ ...             │  │ + Load()                     │
├─────────────────┤  │ + Clear()                    │
│ + Play()        │  └──────────────────────────────┘
│ + Stop()        │           ▲
│ + SetGain()     │           │ 实现
│ ...             │           │
└─────────────────┘  ┌────────┴──────────┐
                     │                   │
            ┌────────┴────────┐  ┌───────┴────────┐
            │  Opus Decoder   │  │  OGG Decoder   │
            │   (Plugin)      │  │   (Plugin)     │
            └─────────────────┘  └────────────────┘
```

## 2. 线程交互时序图

```
主线程                    播放线程                  OpenAL
  │                         │                         │
  │ new AudioPlayer()       │                         │
  ├────────────────────────>│                         │
  │                         │ alGenSources()          │
  │                         ├────────────────────────>│
  │                         │ alGenBuffers(3)         │
  │                         ├────────────────────────>│
  │                         │                         │
  │ Load("music.ogg")       │                         │
  ├────────────────────────>│                         │
  │ 加载插件并解码           │                         │
  │                         │                         │
  │ Play(true)              │                         │
  ├─[lock]─────────────────>│                         │
  │ loop = true             │                         │
  │ Start() 启动线程         │                         │
  │ Playback()              │                         │
  │   ReadData() x3         │                         │
  │   alSourceQueueBuffers()│                         │
  │   ├────────────────────>│────────────────────────>│
  │   alSourcePlay()        │                         │
  │   ├────────────────────>│────────────────────────>│
  │   ps = Play             │                         │
  ├─[unlock]───────────────>│                         │
  │                         │                         │
  │                         │ === Execute() 循环 ===  │
  │                         │                         │
  │                         │ [lock]                  │
  │                         │ UpdateBuffer()          │
  │                         │   alGetSourcei(         │
  │                         │     BUFFERS_PROCESSED)  │
  │                         │   ├────────────────────>│
  │                         │   alSourceUnqueueBuffers│
  │                         │   ├────────────────────>│
  │                         │   decode->Read()        │
  │                         │   alBufferData()        │
  │                         │   ├────────────────────>│
  │                         │   alSourceQueueBuffers()│
  │                         │   ├────────────────────>│
  │                         │ [unlock]                │
  │                         │ WaitTime(0.1s)          │
  │                         │ ⟲ 重复                  │
  │                         │                         │
  │ Pause()                 │                         │
  ├─[lock]─────────────────>│                         │
  │ ps = Pause              │                         │
  ├─[unlock]───────────────>│                         │
  │                         │ alSourcePause()         │
  │                         ├────────────────────────>│
  │                         │ return false (暂停线程)  │
  │                         │                         │
  │ Resume()                │                         │
  ├─[lock]─────────────────>│                         │
  │ ps = Play               │                         │
  │ Start() 恢复线程         │                         │
  ├─[unlock]───────────────>│                         │
  │                         │ 继续 Execute() 循环      │
  │                         │                         │
  │ Stop()                  │                         │
  ├─[lock]─────────────────>│                         │
  │ ps = Exit               │                         │
  ├─[unlock]───────────────>│                         │
  │ WaitExit()              │                         │
  │ (等待线程结束)           │                         │
  │                         │ alSourceStop()          │
  │                         ├────────────────────────>│
  │                         │ ClearBuffer()           │
  │                         │ return false (退出)     │
  │<────────────────────────┤                         │
  │                         │                         │
```

## 3. 数据流图

```
┌──────────────┐
│ 音频文件     │
│ (.ogg/.opus) │
└──────┬───────┘
       │ Load()
       ▼
┌─────────────────────┐
│  audio_data         │ ◄─── 完整压缩文件数据
│  (ALbyte*)          │
└──────┬──────────────┘
       │ decode->Open()
       ▼
┌─────────────────────┐
│  audio_ptr          │ ◄─── 解码器句柄
│  (void*)            │
└──────┬──────────────┘
       │ decode->Read()
       ▼
┌─────────────────────┐
│  audio_buffer       │ ◄─── 解码缓冲区 (1/10秒)
│  (char*)            │      PCM 数据
└──────┬──────────────┘
       │ alBufferData()
       ▼
┌─────────────────────┐
│  buffer[0]          │ ┐
│  buffer[1]          │ ├─── OpenAL 缓冲区
│  buffer[2]          │ ┘    (3个轮换使用)
│  (ALuint)           │
└──────┬──────────────┘
       │ alSourceQueueBuffers()
       ▼
┌─────────────────────┐
│  source             │ ◄─── OpenAL 音源
│  (ALuint)           │
└──────┬──────────────┘
       │ alSourcePlay()
       ▼
┌─────────────────────┐
│  扬声器/耳机         │
└─────────────────────┘
```

## 4. 状态机图

```
                 ┌──────────────┐
                 │     None     │ ◄── 初始状态
                 └───────┬──────┘
                         │
                         │ Play()
                         ▼
    ┌────────────────────────────────┐
    │           Play                 │
    │  (线程运行,持续播放)            │
    └─┬──────────────────────────┬─┬─┘
      │                          │ │
      │ Pause()                  │ │ loop=true &&
      ▼                          │ │ 播放结束
    ┌─────────┐                  │ │ Playback()
    │  Pause  │                  │ └────────┐
    │ (线程暂停)│                  │          ▼
    └────┬────┘                  │   ┌─────────┐
         │                       │   │ 重启解码器│
         │ Resume()              │   └────┬────┘
         └───────────────────────┘        │
                                         │
                                         └────────┐
      Stop() │                                    │
             ▼                                    │
    ┌──────────────┐                             │
    │     Exit     │ ◄───────────────────────────┘
    │  (清理资源)   │      loop=false &&
    └──────┬───────┘      播放结束
           │
           │ 线程退出
           ▼
    ┌──────────────┐
    │     None     │ ◄── 返回初始状态
    └──────────────┘
```

## 5. 三缓冲工作原理

```
时刻 T0: 初始化
┌─────────────────────────────────────────────┐
│ Buffer 0 [========]  ← ReadData()           │
│ Buffer 1 [========]  ← ReadData()           │
│ Buffer 2 [========]  ← ReadData()           │
│                                             │
│ Queue: [0, 1, 2]                            │
│ alSourcePlay() 开始播放                      │
└─────────────────────────────────────────────┘

时刻 T1: Buffer 0 播放完成
┌─────────────────────────────────────────────┐
│ Buffer 0 [--------]  ← 已处理,可重用         │
│ Buffer 1 [===正在播放===]                    │
│ Buffer 2 [========]  ← 等待播放              │
│                                             │
│ UpdateBuffer():                             │
│   alSourceUnqueueBuffers(&buffer[0])        │
│   ReadData(buffer[0]) → [########]          │
│   alSourceQueueBuffers(&buffer[0])          │
│ Queue: [1, 2, 0]                            │
└─────────────────────────────────────────────┘

时刻 T2: Buffer 1 播放完成
┌─────────────────────────────────────────────┐
│ Buffer 0 [########]  ← 等待播放              │
│ Buffer 1 [--------]  ← 已处理,可重用         │
│ Buffer 2 [===正在播放===]                    │
│                                             │
│ UpdateBuffer():                             │
│   alSourceUnqueueBuffers(&buffer[1])        │
│   ReadData(buffer[1]) → [########]          │
│   alSourceQueueBuffers(&buffer[1])          │
│ Queue: [2, 0, 1]                            │
└─────────────────────────────────────────────┘

时刻 T3: Buffer 2 播放完成
┌─────────────────────────────────────────────┐
│ Buffer 0 [===正在播放===]                    │
│ Buffer 1 [########]  ← 等待播放              │
│ Buffer 2 [--------]  ← 已处理,可重用         │
│                                             │
│ UpdateBuffer():                             │
│   alSourceUnqueueBuffers(&buffer[2])        │
│   ReadData(buffer[2]) → [########]          │
│   alSourceQueueBuffers(&buffer[2])          │
│ Queue: [0, 1, 2]                            │
└─────────────────────────────────────────────┘

⟲ 循环继续...
```

## 6. 淡入淡出实现原理

```
音量
  │
1.0│                  ┌────────────────┐
   │                 /│                │\
   │                / │                │ \
   │               /  │                │  \
0.8│              /   │                │   \
   │             /    │                │    \
   │            /     │                │     \
   │           /      │                │      \
0.0│──────────/       │                │       \───────
   └────────┴────────┴────────────────┴────────┴─────> 时间
         开始    淡入期    正常播放      淡出期    结束
         (t0)   (fade_in) (t1~t2)    (fade_out) (total)
   
   if (cur_time - start_time < fade_in_time) {
       // 淡入阶段
       gain = ((cur_time - start_time) / fade_in_time) * gain;
   }
   else if (cur_time - start_time > total_time - fade_out_time) {
       // 淡出阶段
       gain = ((total_time - (cur_time - start_time)) / fade_out_time) * gain;
   }
```

## 7. 自动增益变化原理

```
音量
  │
1.0│ ●────────────────┐
   │                  │
   │                  │ auto_gain.start.gain
   │                  │
0.6│                  │     slope = gap/time
   │                  │    /
   │                  │   /
   │                  │  /
0.2│                  │ /
   │                  │/ ● auto_gain.end.gain
   │                  /
0.0│─────────────────/─────────────────────────> 时间
   └────────────────┴──────────────────┴─────
                 start.time          end.time
                 
   current_gain = start.gain + gap * ((cur_time - start.time) / time);
   
   当 cur_time >= end.time 时:
       auto_gain.open = false;
       SetGain(end.gain);
```

## 8. 内存布局

```
AudioPlayer 对象
┌─────────────────────────────────────────┐
│ ThreadMutex lock                        │
│ ─────────────────────────────────────── │
│ audio_data ────────┐                    │
│                    │                    │
│ audio_ptr ─────┐   │                    │
│                │   │                    │
│ audio_buffer ──│───│───┐                │
│                │   │   │                │
│ decode ────┐   │   │   │                │
│            │   │   │   │                │
│ audiosource│   │   │   │                │
│ source     │   │   │   │                │
│ buffer[3]  │   │   │   │                │
│ ...        │   │   │   │                │
└────────────┼───┼───┼───┼────────────────┘
             │   │   │   │
             │   │   │   └────> ┌───────────────────┐
             │   │   │          │ 解码缓冲区         │
             │   │   │          │ [PCM data]        │
             │   │   │          │ (1/10秒音频)      │
             │   │   │          └───────────────────┘
             │   │   │
             │   │   └────────> ┌───────────────────┐
             │   │              │ 压缩音频数据       │
             │   │              │ [compressed]      │
             │   │              │ (整个文件)        │
             │   │              └───────────────────┘
             │   │
             │   └────────────> ┌───────────────────┐
             │                  │ 解码器上下文       │
             │                  │ (decoder state)   │
             │                  └───────────────────┘
             │
             └──────────────────> ┌───────────────────┐
                                  │ 解码器接口         │
                                  │ (plugin)          │
                                  │ - Open()          │
                                  │ - Read()          │
                                  │ - Close()         │
                                  └───────────────────┘
```

这些图表清晰地展示了 AudioPlayer 的架构设计、工作流程和关键技术实现。
